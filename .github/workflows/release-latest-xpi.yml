name: Build & upload nc4tb-latest.xpi

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  latest-xpi:
    if: ${{ !github.event.release.draft && !github.event.release.prerelease }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build XPI (nc4tb-latest.xpi)
        run: |
          mkdir -p build
          rm -f build/nc4tb-latest.xpi
          zip -r build/nc4tb-latest.xpi . \
            -x '.git/*' \
            -x '.github/*' \
            -x 'build/*' \
            -x 'node_modules/*' \
            -x '*.xpi' \
            -x '*.zip' \
            -x '*/.DS_Store'

      - name: Upload asset to GitHub Release (overwrite)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" build/nc4tb-latest.xpi --clobber
